// backend/email.jsw
import { fetch } from 'wix-fetch';
import { getSecret } from 'wix-secrets-backend';

export async function enviarEmail(transcripcion) {
  const apiKey = await getSecret("SENDGRID_KEY");
  const body = transcripcion.map(m => `${m.tipo}: ${m.mensaje}`).join('\n');

  const response = await fetch("https://api.sendgrid.com/v3/mail/send", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${apiKey}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      personalizations: [{
        to: [{ email: "cracevedoc@gmail.com" }]
      }],
      from: { email: "elboricano@vistapelicano.com", name: "BorÃ­ Cano" },
      subject: "TranscripciÃ³n del chat",
      content: [{ type: "text/plain", value: body }]
    })
  });

  if (!response.ok) {
    throw new Error(`SendGrid error: ${response.statusText}`);
  }
  console.log("ðŸ“¬ EN: Transcript emailed.");
}

export async function enviarEmailAlHuesped(email, mensaje) {
  const apiKey = await getSecret("SENDGRID_KEY");

  const response = await fetch("https://api.sendgrid.com/v3/mail/send", {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${apiKey}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      personalizations: [{
        to: [{ email: email }]
      }],
      from: { email: "elboricano@vistapelicano.com", name: "BorÃ­ Cano" },
      subject: "Message from BorÃ­ Cano",
      content: [{ type: "text/plain", value: mensaje }]
    })
  });

  if (!response.ok) {
    throw new Error(`SendGrid error: ${response.statusText}`);
  }
  console.log("ðŸ“¬ EN: Email sent to guest.");
}